services:
    mysql:
        image: mysql:8.4
        container_name: laravel-mysql
        restart: "no"
        ports:
            - "3306:3306"
        environment:
            MYSQL_ROOT_PASSWORD: secret
            MYSQL_DATABASE: laravel
            MYSQL_USER: laravel
            MYSQL_PASSWORD: secret
        volumes:
            - mysql-data:/var/lib/mysql
        command:
            - --innodb-buffer-pool-size=64M
            - --innodb-log-file-size=16M
            - --innodb-flush-method=O_DIRECT
            - --innodb-flush-log-at-trx-commit=2
            - --max-connections=20
            - --key-buffer-size=8M
            - --table-open-cache=64
            - --sort-buffer-size=256K
            - --read-buffer-size=256K
            - --thread-cache-size=4
            - --tmp-table-size=8M
            - --max-heap-table-size=8M
            - --performance-schema=OFF
            - --skip-log-bin
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "--silent"]
            interval: 10s
            timeout: 5s
            retries: 3
            start_period: 30s
        deploy:
            resources:
                limits:
                    memory: 256M

    valkey:
        image: valkey/valkey:8-alpine
        container_name: laravel-valkey
        restart: "no"
        ports:
            - "6379:6379"
        volumes:
            - valkey-data:/data
        command:
            - valkey-server
            - --maxmemory
            - 32mb
            - --maxmemory-policy
            - allkeys-lru
            - --save
            - ""
            - --appendonly
            - "no"
        healthcheck:
            test: ["CMD", "valkey-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 3
        deploy:
            resources:
                limits:
                    memory: 64M

volumes:
    mysql-data:
    valkey-data:
